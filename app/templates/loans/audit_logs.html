{% extends 'base.html' %}

{% block title %}Audit Logs - Loan #{{ loan.id }}{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">Audit Logs</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item">
                        <a href="{{ url_for('groups.view_group', group_id=loan.group_id) }}">{{ loan.group.name|title }}</a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="{{ url_for('loans.view_loan', loan_id=loan.id) }}">Loan #{{ loan.id }}</a>
                    </li>
                    <li class="breadcrumb-item active">Audit Logs</li>
                </ol>
            </nav>
        </div>
        <div class="d-flex gap-2 d-print-none">
            <a href="{{ url_for('loans.view_loan', loan_id=loan.id) }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i> Back to Loan
            </a>
            <button class="btn btn-primary" onclick="window.print()">
                <i class="bi bi-printer me-1"></i> Print Report
            </button>
        </div>
    </div>

    <div class="card border-0 shadow-sm mb-4 bg-light">
        <div class="card-body">
            <div class="row text-center text-md-start g-3">
                <div class="col-6 col-md-3 border-end">
                    <small class="text-muted d-block text-uppercase small fw-bold">Loan Amount</small>
                    <span class="h4 mb-0 fw-bold">₹{{ "{:,.0f}".format(loan.amount) }}</span>
                </div>
                <div class="col-6 col-md-3 border-end">
                    <small class="text-muted d-block text-uppercase small fw-bold">Status</small>
                    <span class="badge {% if loan.status == 'pending' %}bg-warning text-dark{% elif loan.status in ['approved', 'disbursed', 'completed'] %}bg-success{% else %}bg-secondary{% endif %}">
                        {{ loan.status|replace('_', ' ')|upper }}
                    </span>
                </div>
                <div class="col-6 col-md-3 border-end">
                    <small class="text-muted d-block text-uppercase small fw-bold">Borrower</small>
                    <span class="h6 mb-0 d-block">{{ loan.requester.name }}</span>
                </div>
                <div class="col-6 col-md-3">
                    <small class="text-muted d-block text-uppercase small fw-bold">Balance Due</small>
                    <span class="h6 mb-0 d-block text-danger">₹{{ "{:,.0f}".format(loan.get_remaining_amount()) }}</span>
                </div>
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm">
        <div class="card-header bg-white py-3 border-bottom">
            <h5 class="mb-0"><i class="bi bi-journal-text me-2"></i>Full Activity History</h5>
        </div>
        <div class="card-body">
            <div class="timeline">

                <div class="timeline-item pb-4">
                    <div class="timeline-marker bg-primary text-white"><i class="bi bi-plus-lg"></i></div>
                    <div class="timeline-content">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="fw-bold mb-1">Loan Application Submitted</h6>
                                <p class="mb-2">Request for ₹{{ "{:,.0f}".format(loan.amount) }}</p>
                                <div class="bg-white p-2 rounded border small italic">
                                    "{{ loan.reason }}"
                                </div>
                            </div>
                            <span class="badge bg-light text-dark border">{{ loan.created_at.strftime('%d %b %Y, %H:%M') }}</span>
                        </div>
                    </div>
                </div>

                {% for vote in approvals %}
                <div class="timeline-item pb-4">
                    <div class="timeline-marker {% if vote.approved %}bg-success{% else %}bg-danger{% endif %} text-white">
                        <i class="bi {% if vote.approved %}bi-check-lg{% else %}bi-x-lg{% endif %}"></i>
                    </div>
                    <div class="timeline-content">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="fw-bold mb-0">Vote: {{ 'Approved' if vote.approved else 'Rejected' }}</h6>
                                <small class="text-muted">Cast by <strong>{{ vote.approver.name }}</strong></small>
                                {% if vote.comment %}
                                <p class="mt-2 mb-0 small text-muted font-italic">"{{ vote.comment }}"</p>
                                {% endif %}
                            </div>
                            <span class="badge bg-light text-dark border">{{ vote.voted_at.strftime('%d %b %Y, %H:%M') }}</span>
                        </div>
                    </div>
                </div>
                {% endfor %}

                {% if loan.disbursed_at %}
                <div class="timeline-item pb-4">
                    <div class="timeline-marker bg-warning text-dark"><i class="bi bi-cash-stack"></i></div>
                    <div class="timeline-content">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="fw-bold mb-1">Funds Disbursed</h6>
                                <p class="mb-0 small">Amount: <strong>₹{{ "{:,.0f}".format(loan.approved_amount) }}</strong></p>
                                <p class="mb-0 small text-muted">Transferred by: {{ loan.disbursed_by_user.name if loan.disbursed_by_user else 'System Admin' }}</p>
                            </div>
                            <span class="badge bg-light text-dark border">{{ loan.disbursed_at.strftime('%d %b %Y, %H:%M') }}</span>
                        </div>
                    </div>
                </div>
                {% endif %}

                {% for repayment in repayments %}
                <div class="timeline-item pb-4">
                    <div class="timeline-marker bg-info text-white"><i class="bi bi-arrow-return-left"></i></div>
                    <div class="timeline-content">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="fw-bold mb-1">Repayment Received</h6>
                                <p class="mb-1"><strong>₹{{ "{:,.0f}".format(repayment.amount) }}</strong></p>
                                <p class="mb-0 small text-muted">
                                    Method: {{ repayment.payment_method|title if repayment.payment_method else 'Standard' }} |
                                    Payer: {{ repayment.payer.name }}
                                </p>
                            </div>
                            <span class="badge bg-light text-dark border">
                                {{ (repayment.approved_at or repayment.submitted_at).strftime('%d %b %Y, %H:%M') }}
                            </span>
                        </div>
                    </div>
                </div>
                {% endfor %}

                {% if loan.status == 'completed' %}
                <div class="timeline-item pb-4">
                    <div class="timeline-marker bg-dark text-white"><i class="bi bi-flag-fill"></i></div>
                    <div class="timeline-content border-success bg-success-light">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="fw-bold mb-1 text-success">Loan Fully Repaid</h6>
                                <p class="mb-0 small">The loan record has been closed.</p>
                            </div>
                            <span class="badge bg-success text-white">
                                {{ loan.completed_at.strftime('%d %b %Y') if loan.completed_at else 'Completed' }}
                            </span>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
/* Modern Vertical Timeline */
.timeline {
    position: relative;
    padding: 10px 0;
    list-style: none;
}

.timeline::before {
    content: '';
    position: absolute;
    top: 0;
    bottom: 0;
    left: 1.25rem;
    width: 2px;
    background: #e9ecef;
}

.timeline-item {
    position: relative;
    padding-left: 3.5rem;
}

.timeline-marker {
    position: absolute;
    left: 0;
    width: 2.5rem;
    height: 2.5rem;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 4px solid #fff;
    z-index: 1;
}

.timeline-content {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 0.5rem;
    border: 1px solid #edf2f7;
}

.bg-success-light {
    background-color: #f0fff4 !important;
}

@media print {
    body { background: white; }
    .container { width: 100% !important; max-width: 100% !important; }
    .timeline-content { border: 1px solid #ccc !important; }
    .timeline::before { background: #ccc !important; -webkit-print-color-adjust: exact; }
}
</style>
{% endblock %}