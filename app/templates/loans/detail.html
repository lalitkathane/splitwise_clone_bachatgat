{% extends 'base.html' %}

{% block title %}
Loan #{{ loan.id }} - ₹{{ "%.0f"|format(loan.amount) }}
{% endblock %}

{% block content %}
<!-- Breadcrumb Navigation -->
<nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb bg-transparent p-0 mb-2">
        <li class="breadcrumb-item">
            <a href="{{ url_for('groups.view_group', group_id=group.id) }}" class="text-decoration-none">
                <i class="bi bi-people-fill me-1"></i> {{ group.name|title }}
            </a>
        </li>
        <li class="breadcrumb-item active">Loan Details</li>
    </ol>
    <div class="d-flex align-items-center gap-3 fs-6 flex-wrap">
        <span class="badge bg-light text-dark border">ID: #{{ loan.id }}</span>
        <span class="vr d-none d-md-inline"></span>
        <span class="text-muted">Requested by: <strong class="text-dark">{{ loan.requester.name }}</strong></span>
        <span class="vr d-none d-md-inline"></span>
        <span class="text-muted">Reason: <strong class="text-dark">{{ loan.reason }}</strong></span>
    </div>
</nav>

<!-- Action Alerts Section -->
{% if loan.status == 'disbursed' and details.next_emi and current_user.id == loan.requested_by %}
    {% set days_left = (details.next_emi.due_date - today).days %}  <!-- FIXED: Removed .date() -->
    <div class="alert alert-warning border-0 shadow-sm mb-4 d-flex align-items-center" role="alert">
        <div class="flex-shrink-0">
            <i class="bi bi-exclamation-triangle-fill fs-4 me-3"></i>
        </div>
        <div class="flex-grow-1">
            <h6 class="alert-heading mb-1">EMI #{{ details.next_emi.installment }} Due in {{ days_left }} days</h6>
            <p class="mb-0 small">Amount: ₹{{ "%.2f"|format(details.next_emi.emi_amount) }} • Due Date: {{ details.next_emi.due_date.strftime('%B %d, %Y') }}</p>
        </div>
        <a href="{{ url_for('loans.repay_loan', loan_id=loan.id) }}" class="btn btn-warning text-white ms-3">
            <i class="bi bi-credit-card me-1"></i> Pay Now
        </a>
    </div>
{% endif %}

{% if request.args.get('edited') == 'true' %}
<div class="alert alert-success alert-dismissible fade show mb-4" role="alert">
    <i class="bi bi-check-circle-fill me-2"></i> Loan updated successfully!
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

{% if loan.status == 'disbursed' and loan.is_fully_repaid() and is_admin %}
<div class="alert alert-success border-0 shadow-sm mb-4 d-flex align-items-center" role="alert">
    <div class="flex-shrink-0">
        <i class="bi bi-check-circle-fill fs-4 me-3"></i>
    </div>
    <div class="flex-grow-1">
        <h6 class="alert-heading mb-1">Loan Fully Repaid</h6>
        <p class="mb-0 small">This loan has been completely repaid. You can now close it.</p>
    </div>
    <form action="{{ url_for('loans.close_loan', loan_id=loan.id) }}" method="POST" class="ms-3">
        <button type="submit" class="btn btn-success text-white" onclick="return confirm('Close this loan? This action cannot be undone.')">
            <i class="bi bi-lock-fill me-1"></i> Close Loan
        </button>
    </form>
</div>
{% endif %}

<!-- Voting Section -->
{% if loan.status == 'pending' %}
    {% if loan.requested_by != current_user.id and not user_vote and can_vote %}
    <div class="card border-0 shadow mb-4 overflow-hidden">
        <div class="card-header bg-primary text-white py-2">
            <h6 class="mb-0 small fw-bold text-uppercase tracking-wider">
                <i class="bi bi-hand-thumbs-up-fill me-2"></i>Your Vote Required
            </h6>
        </div>
        <div class="card-body p-3">
            <form method="POST" action="{{ url_for('loans.vote_loan', loan_id=loan.id) }}">
                <div class="row align-items-center g-3">
                    <div class="col-md-5 border-end">
                        <div class="d-flex flex-column justify-content-center h-100">
                            <p class="mb-1 small">
                                <span class="text-muted">Loan Request:</span>
                                <strong class="ms-1 text-dark">₹{{ "%.2f"|format(loan.amount) }}</strong>
                                <span class="text-muted">by</span> {{ loan.requester.name }}
                            </p>
                            <p class="mb-0 small text-truncate">
                                <span class="text-muted">Purpose:</span>
                                <span class="ms-1 fst-italic">{{ loan.reason|default('Not specified', true) }}</span>
                            </p>
                        </div>
                    </div>
                    <div class="col-md-7">
                        <div class="d-flex align-items-center gap-2">
                            <div class="flex-grow-1">
                                <input type="text" name="comment" class="form-control form-control-sm"
                                       placeholder="Add comment (optional)" autocomplete="off">
                            </div>
                            <div class="d-flex gap-2">
                                <button type="submit" name="vote" value="approve" class="btn btn-success btn-sm px-3 fw-bold">
                                    <i class="bi bi-check-circle me-1"></i> Approve
                                </button>
                                <button type="submit" name="vote" value="reject" class="btn btn-outline-danger btn-sm px-3 fw-bold">
                                    <i class="bi bi-x-circle me-1"></i> Reject
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
    {% elif user_vote %}
    <div class="alert alert-light border shadow-sm mb-4 d-flex justify-content-between align-items-center">
        <span class="small text-muted"><i class="bi bi-info-circle me-2"></i>You have already cast your vote.</span>
        <span class="badge {% if user_vote.approved %}bg-success{% else %}bg-danger{% endif %} px-3 py-2">
            YOUR VOTE: {{ 'APPROVED' if user_vote.approved else 'REJECTED' }}
        </span>
    </div>
    {% elif loan.requested_by == current_user.id %}
    <div class="alert alert-info border shadow-sm mb-4 d-flex justify-content-between align-items-center">
        <span class="small"><i class="bi bi-hourglass-split me-2"></i>This is your loan request. Waiting for members to vote.</span>
    </div>
    {% endif %}
{% endif %}

<!-- Stats Grid -->
<div class="row g-3 mb-4">
    <div class="col-6 col-md-3">
        <div class="card border-0 shadow-sm h-100 border-start border-primary border-4">
            <div class="card-body text-center p-3">
                <small class="text-muted d-block text-uppercase fw-bold x-small mb-1">Loan Amount</small>
                <h4 class="fw-bold mb-0">₹{{ "%.0f"|format(loan.amount) }}</h4>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card border-0 shadow-sm h-100 border-start border-info border-4">
            <div class="card-body text-center p-3">
                <small class="text-muted d-block text-uppercase fw-bold x-small mb-1">Status</small>
                <span class="badge {% if loan.status == 'pending' %}bg-warning text-dark{% elif loan.status in ['approved', 'disbursed', 'completed'] %}bg-success{% elif loan.status == 'pre_approved' %}bg-info{% else %}bg-secondary{% endif %} rounded-pill">
                    {{ loan.status|replace('_', ' ')|title }}
                </span>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card border-0 shadow-sm h-100 border-start border-success border-4">
            <div class="card-body text-center p-3">
                <small class="text-muted d-block text-uppercase fw-bold x-small mb-1">Repaid</small>
                <h4 class="fw-bold mb-0 text-success">₹{{ "%.0f"|format(loan.total_repaid) }}</h4>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card border-0 shadow-sm h-100 border-start border-danger border-4">
            <div class="card-body text-center p-3">
                <small class="text-muted d-block text-uppercase fw-bold x-small mb-1">Remaining</small>
                <h4 class="fw-bold mb-0 text-danger">₹{{ "%.0f"|format(loan.get_remaining_amount()) }}</h4>
            </div>
        </div>
    </div>
</div>

<!-- Main Content Split -->
<div class="row g-4">
    <!-- LEFT COLUMN -->
    <div class="col-lg-8">
        <!-- In detail (1).html, update the Loan Overview Card section: -->

<!-- Loan Overview Card -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-body p-4">
        {% if loan.borrower_notes %}
        <div class="p-3 bg-info-subtle rounded-3 mb-4">
            <small class="text-info text-uppercase fw-bold d-block mb-2">Borrower Notes</small>
            <p class="mb-0 small">{{ loan.borrower_notes|replace('\n', '<br>'|safe) }}</p>
        </div>
        {% endif %}

        {% if is_admin and loan.admin_remarks %}
        <div class="p-3 bg-warning-subtle rounded-3 mb-4">
            <small class="text-warning text-uppercase fw-bold d-block mb-2">Admin Remarks</small>
            <p class="mb-0 small">{{ loan.admin_remarks|replace('\n', '<br>'|safe) }}</p>
        </div>
        {% endif %}

        {% if loan.status == 'pending' %}
            <h6 class="fw-bold mb-3 small">VOTING PROGRESS</h6>
            {% set vote_progress = (details.voting.votes_cast / details.voting.eligible_voters * 100) if details.voting.eligible_voters > 0 else 0 %}
            <div class="progress rounded-pill mb-2" style="height: 12px;">
                <div class="progress-bar bg-primary" style="width: {{ vote_progress }}%"></div>
            </div>
            <div class="d-flex justify-content-between x-small text-muted">
                <span>{{ details.voting.votes_cast }} / {{ details.voting.eligible_voters }} members voted</span>
                <div class="d-flex gap-2">
                    <span class="fw-bold text-success">{{ details.voting.approvals }} Approvals</span>
                    <span class="fw-bold text-danger">{{ details.voting.rejections }} Rejections</span>
                </div>
            </div>
            <div class="mt-2 text-muted x-small">
                <i class="bi bi-info-circle me-1"></i> Requires {{ details.voting.required_approvals }} approvals
            </div>

        {% elif loan.status in ['disbursed', 'completed'] %}
            <h6 class="fw-bold mb-3 small">REPAYMENT PROGRESS</h6>
            {% set repay_progress = (loan.total_repaid / loan.total_repayable * 100) if loan.total_repayable else 0 %}
            <div class="progress rounded-pill mb-2" style="height: 12px;">
                <div class="progress-bar bg-success" style="width: {{ repay_progress }}%"></div>
            </div>
            <div class="d-flex justify-content-between x-small text-muted">
                <span>{{ "%.1f"|format(repay_progress) }}% Collected</span>
                <span class="fw-bold">Total: ₹{{ "%.0f"|format(loan.total_repayable or 0) }}</span>
            </div>
            {% elif loan.status == 'disbursed' and loan.is_fully_repaid() %}
            <div class="mt-4 pt-3 border-top">
                <div class="alert alert-success mb-0 py-2">
                    <i class="bi bi-check-circle-fill me-2"></i>
                    Loan fully repaid! Awaiting admin closure.
                </div>
            </div>
        {% endif %}
    </div>
</div>

        <!-- Pending Repayments (Admin Only) -->
        {% if is_admin and pending_repayments %}
        <div class="card border-0 shadow-sm mb-4 border-start border-warning border-4">
            <div class="card-header bg-white py-3 border-0 d-flex justify-content-between align-items-center">
                <h6 class="mb-0 fw-bold text-warning-emphasis"><i class="bi bi-clock-history me-2"></i>Pending Repayment Approvals</h6>
                <span class="badge bg-warning rounded-pill">{{ pending_repayments|length }}</span>
            </div>
            <div class="table-responsive">
                <table class="table align-middle table-hover mb-0">
                    <thead class="bg-light x-small text-muted">
                        <tr>
                            <th class="ps-4">AMOUNT</th>
                            <th>DETAILS</th>
                            <th>SUBMITTED</th>
                            <th class="text-end pe-4">ACTION</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for repayment in pending_repayments %}
                        <tr class="small">
                            <td class="ps-4 fw-bold">₹{{ "%.2f"|format(repayment.amount) }}</td>
                            <td class="text-muted">
                                <span class="d-block">P: ₹{{ "%.0f"|format(repayment.principal_component or 0) }}</span>
                                <span class="d-block">I: ₹{{ "%.0f"|format(repayment.interest_component or 0) }}</span>
                            </td>
                            <td>{{ repayment.submitted_at.strftime('%d %b') }}</td>
                            <td class="text-end pe-4">
                                <div class="d-flex justify-content-end gap-1">
                                    <form action="{{ url_for('wallet.approve_repayment_route', repayment_id=repayment.id) }}" method="POST">
                                        <button type="submit" class="btn btn-success btn-sm p-1 px-2" onclick="return confirm('Approve this repayment?')">
                                            <i class="bi bi-check-lg"></i>
                                        </button>
                                    </form>
                                    <button type="button" class="btn btn-danger btn-sm p-1 px-2" data-bs-toggle="modal" data-bs-target="#rejectModal{{ repayment.id }}">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </div>

                                <!-- Reject Modal -->
                                <div class="modal fade" id="rejectModal{{ repayment.id }}" tabindex="-1">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <form action="{{ url_for('wallet.reject_repayment', repayment_id=repayment.id) }}" method="POST">
                                                <div class="modal-header">
                                                    <h5 class="modal-title">Reject Repayment</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                                </div>
                                                <div class="modal-body text-start">
                                                    <p>Reject repayment of <strong>₹{{ "%.2f"|format(repayment.amount) }}</strong>?</p>
                                                    <label class="form-label small text-muted">Reason</label>
                                                    <textarea name="reason" class="form-control" required></textarea>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="submit" class="btn btn-danger">Confirm Reject</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

        <!-- EMI Schedule Preview -->
        {% if details.emi_schedule %}
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white py-3 border-0 d-flex justify-content-between align-items-center">
                <h6 class="mb-0 fw-bold">Recent Installments</h6>
                <div>
                    <a href="{{ url_for('loans.view_emi_schedule', loan_id=loan.id) }}" class="text-decoration-none x-small fw-bold me-3">View Full Schedule</a>
                    <span class="badge bg-light text-dark">
                        {{ details.emi_schedule|selectattr('is_paid')|list|length }}/{{ details.emi_schedule|length }} paid
                    </span>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table align-middle table-hover mb-0">
                    <thead class="bg-light x-small text-muted">
                        <tr>
                            <th class="ps-4">#</th>
                            <th>DATE</th>
                            <th>AMOUNT</th>
                            <th class="text-end pe-4">STATUS</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for emi in details.emi_schedule[:5] %}
                        <tr class="small">
                            <td class="ps-4 text-muted">{{ emi.installment }}</td>
                            <td>{{ emi.due_date.strftime('%d %b %Y') }}</td>
                            <td class="fw-bold">₹{{ "%.2f"|format(emi.emi_amount) }}</td>
                            <td class="text-end pe-4">
                                {% if emi.is_paid %}
                                    <span class="text-success small"><i class="bi bi-check-circle-fill me-1"></i> Paid</span>
                                {% else %}
                                    {% set days_overdue = (today - emi.due_date).days %}
                                    {% if days_overdue > 0 %}
                                        <span class="badge bg-danger text-white fw-normal">Overdue {{ days_overdue }} days</span>
                                    {% else %}
                                        <span class="badge bg-light text-dark border fw-normal">Pending</span>
                                    {% endif %}
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

        <!-- Vote History -->
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white py-3 border-0 d-flex justify-content-between align-items-center">
                <h6 class="mb-0 fw-bold">Voting History</h6>
                <span class="badge bg-light text-dark">{{ all_votes|length }} votes</span>
            </div>
            {% if all_votes %}
            <div class="table-responsive">
                <table class="table align-middle table-hover mb-0">
                    <thead class="bg-light x-small text-muted">
                        <tr>
                            <th class="ps-4">MEMBER</th>
                            <th>VOTE</th>
                            <th>COMMENT</th>
                            <th class="text-end pe-4">DATE</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for vote in all_votes %}
                        <tr class="small">
                            <td class="ps-4 fw-bold">
                                {{ vote.approver.name }}
                                {% if vote.approver.id == current_user.id %}<span class="badge bg-light text-dark ms-1">You</span>{% endif %}
                            </td>
                            <td>
                                {% if vote.approved %}
                                    <span class="badge bg-success-subtle text-success border border-success-subtle">Approved</span>
                                {% else %}
                                    <span class="badge bg-danger-subtle text-danger border border-danger-subtle">Rejected</span>
                                {% endif %}
                            </td>
                            <td class="text-muted fst-italic">{{ vote.comment|default('-', true)|truncate(40) }}</td>
                            <td class="text-end pe-4 text-muted">{{ vote.voted_at.strftime('%d %b %Y') }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="p-4 text-center text-muted small">
                <i class="bi bi-hourglass me-1"></i> No votes cast yet.
            </div>
            {% endif %}
        </div>
    </div>

    <!-- RIGHT COLUMN -->
    <div class="col-lg-4">
        <!-- Actions Panel -->
        <div class="card border-0 shadow-sm bg-dark text-white mb-4">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="fw-bold mb-0"><i class="bi bi-shield-lock me-2"></i>Actions</h6>
                    {% if is_admin %}
                    <a href="{{ url_for('loans.loan_audit_logs', loan_id=loan.id) }}" class="text-white-50 small text-decoration-none">
                        <i class="bi bi-list-check me-1"></i> Audit Logs
                    </a>
                    {% endif %}
                </div>

                <!-- Action Logic -->
                {% if loan.status == 'pre_approved' and can_final_approve %}
                    <p class="small text-white-50 mb-3">Majority voted yes. Final admin approval required.</p>
                    <form action="{{ url_for('loans.final_approve_loan', loan_id=loan.id) }}" method="POST">
                        <button type="submit" class="btn btn-success w-100 py-2 fw-bold mb-2" onclick="return confirm('Confirm Final Approval?')">
                            <i class="bi bi-check-circle-fill me-2"></i>Final Approve
                        </button>
                    </form>

                {% elif loan.status == 'approved' and not loan.disbursed_at and is_admin %}
                    <div class="mb-3 small">
                        <div class="d-flex justify-content-between">
                            <span class="text-white-50">Wallet Balance:</span>
                            <span>₹{{ "%.2f"|format(group.wallet.balance) }}</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="text-white-50">Loan Amount:</span>
                            <span>₹{{ "%.2f"|format(loan.approved_amount) }}</span>
                        </div>
                    </div>
                    <form action="{{ url_for('wallet.disburse', loan_id=loan.id) }}" method="POST">
                        <button class="btn btn-primary w-100 py-2 fw-bold" onclick="return confirm('Transfer funds now?')">
                            <i class="bi bi-send me-2"></i>Disburse Funds
                        </button>
                    </form>

                {% elif loan.status == 'disbursed' and can_repay and current_user.id == loan.requested_by %}
                    <a href="{{ url_for('loans.repay_loan', loan_id=loan.id) }}" class="btn btn-warning w-100 py-2 fw-bold text-dark mb-2">
                        <i class="bi bi-cash-coin me-2"></i>Make Repayment
                    </a>

                {% else %}
                    <p class="small text-white-50 mb-2 text-center">No pending actions</p>
                {% endif %}

                <!-- Admin Actions -->
                {% if is_admin %}
                <hr class="my-3 text-white-50">
                <div class="d-grid gap-2">
                    {% if loan.status == 'disbursed' and loan.is_fully_repaid() %}
                    <form action="{{ url_for('loans.close_loan', loan_id=loan.id) }}" method="POST">
                        <button type="submit" class="btn btn-success w-100 py-2 fw-bold" onclick="return confirm('Close this loan? This action cannot be undone.')">
                            <i class="bi bi-lock-fill me-2"></i> Close Loan
                        </button>
                    </form>
                    {% endif %}

                </div>
                {% endif %}
            </div>
        </div>

        <!-- Loan Terms -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white py-3 border-0 d-flex justify-content-between align-items-center">
                <h6 class="mb-0 fw-bold">Loan Terms</h6>
                {% if is_admin %}
                <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#editLoanModal">
                    <i class="bi bi-pencil-square me-1"></i> Edit
                </button>
                {% endif %}
            </div>
            <div class="card-body p-4">
                <div class="d-flex justify-content-between mb-3 small">
                    <span class="text-muted">Interest Rate</span>
                    <span class="fw-bold">{{ loan.interest_rate or group.default_interest_rate }}% /yr</span>
                </div>
                <div class="d-flex justify-content-between mb-3 small">
                    <span class="text-muted">Duration</span>
                    <span class="fw-bold">{{ loan.loan_duration_months }} Months</span>
                </div>
                <div class="d-flex justify-content-between mb-3 small">
                    <span class="text-muted">Repayment</span>
                    <span class="fw-bold text-uppercase">{{ loan.repayment_type or 'Not set' }}</span>
                </div>
                <div class="d-flex justify-content-between mb-3 small border-top pt-2">
                    <span class="text-muted">Total Interest</span>
                    <span class="fw-bold text-warning">₹{{ "%.2f"|format(loan.total_interest or 0) }}</span>
                </div>
                <hr>
                {% if loan.emi_amount %}
                <div class="d-flex justify-content-between align-items-center">
                    <span class="text-primary fw-bold small">MONTHLY EMI</span>
                    <span class="h5 fw-bold text-primary mb-0">₹{{ "%.2f"|format(loan.emi_amount) }}</span>
                </div>
                {% else %}
                <div class="d-flex justify-content-between align-items-center">
                    <span class="text-primary fw-bold small">TOTAL PAYABLE</span>
                    <span class="h5 fw-bold text-primary mb-0">₹{{ "%.2f"|format(loan.total_repayable or 0) }}</span>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Important Dates -->
        <div class="card border-0 shadow-sm">
            <div class="card-body p-4">
                <h6 class="fw-bold mb-4">Important Dates</h6>
                <div class="d-flex justify-content-between mb-3 small">
                    <span class="text-muted">Requested</span>
                    <span class="fw-bold">{{ loan.created_at.strftime('%d %b %Y') }}</span>
                </div>
                {% if loan.approved_at %}
                <div class="d-flex justify-content-between mb-3 small">
                    <span class="text-muted">Approved</span>
                    <span class="fw-bold">{{ loan.approved_at.strftime('%d %b %Y') }}</span>
                </div>
                {% endif %}
                {% if loan.disbursed_at %}
                <div class="d-flex justify-content-between mb-3 small">
                    <span class="text-muted">Disbursed</span>
                    <span class="fw-bold">{{ loan.disbursed_at.strftime('%d %b %Y') }}</span>
                </div>
                {% endif %}
                {% if loan.expected_completion %}
                <div class="d-flex justify-content-between mb-3 small">
                    <span class="text-muted">Expected Completion</span>
                    <span class="fw-bold">{{ loan.expected_completion.strftime('%d %b %Y') }}</span>
                </div>
                {% endif %}
                <!-- In detail (1).html, add this to the Important Dates section: -->
{% if loan.last_updated_at %}
<div class="d-flex justify-content-between mb-3 small">
    <span class="text-muted">Last Updated</span>
    <span class="fw-bold">{{ loan.last_updated_at.strftime('%d %b %Y') }}</span>
</div>
{% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Footer Buttons -->
<div class="mt-4 d-flex flex-wrap gap-2">
    <a href="{{ url_for('groups.view_group', group_id=group.id) }}" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-arrow-left me-1"></i> Back to Group
    </a>
    <a href="{{ url_for('loans.list_loans', group_id=group.id) }}" class="btn btn-outline-primary btn-sm">
        <i class="bi bi-list-ul me-1"></i> All Loans
    </a>
    {% if loan.status in ['disbursed', 'completed'] %}
    <a href="{{ url_for('loans.repayment_history', loan_id=loan.id) }}" class="btn btn-outline-info btn-sm">
        <i class="bi bi-clock-history me-1"></i> Repayment History
    </a>
    {% endif %}
    {% if is_admin %}
    <a href="{{ url_for('loans.loan_audit_logs', loan_id=loan.id) }}" class="btn btn-outline-warning btn-sm">
        <i class="bi bi-list-check me-1"></i> Audit Logs
    </a>
    {% endif %}
</div>

<!-- Edit Loan Modal (Admin Only) -->
{% if is_admin %}
<div class="modal fade" id="editLoanModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form action="{{ url_for('loans.edit_loan', loan_id=loan.id) }}" method="POST">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Loan #{{ loan.id }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Reason for Changes</label>
                        <textarea name="change_reason" class="form-control" rows="2" placeholder="Explain why you are making these changes..." required></textarea>
                        <div class="form-text">This will be recorded in the audit log.</div>
                    </div>

                    <div class="row g-3">
                        {% if loan.status in ['pending', 'pre_approved'] %}
                        <div class="col-md-6">
                            <label class="form-label">Loan Amount (₹)</label>
                            <input type="number" name="amount" class="form-control" step="0.01" min="1"
                                   value="{{ loan.amount }}" {% if loan.status != 'pending' %}readonly{% endif %}>
                            <div class="form-text">Can only be changed while pending.</div>
                        </div>
                        {% endif %}

                        <div class="col-md-6">
                            <label class="form-label">Interest Rate (%)</label>
                            <input type="number" name="interest_rate" class="form-control" step="0.01" min="0"
                                   value="{{ loan.interest_rate or group.default_interest_rate }}">
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Duration (Months)</label>
                            <input type="number" name="loan_duration" class="form-control" min="1"
                                   value="{{ loan.loan_duration_months }}">
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Repayment Type</label>
                            <select name="repayment_type" class="form-select">
                                <option value="emi" {% if loan.repayment_type == 'emi' %}selected{% endif %}>EMI</option>
                                <option value="bullet" {% if loan.repayment_type == 'bullet' %}selected{% endif %}>Bullet Payment</option>
                            </select>
                        </div>
                    </div>

                    <div class="mt-4">
                        <label class="form-label fw-bold">Add Admin Remarks (Optional)</label>
                        <textarea name="remarks" class="form-control" rows="2" placeholder="Internal notes for admins..."></textarea>
                    </div>

                    <div class="mt-3">
                        <label class="form-label fw-bold">Add Borrower Notes (Optional)</label>
                        <textarea name="notes" class="form-control" rows="2" placeholder="Notes visible to borrower..."></textarea>
                    </div>

                    {% if loan.status in ['pre_approved', 'approved', 'disbursed'] %}
                    <div class="alert alert-warning mt-3 small">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        Changing financial terms will recalculate the entire EMI schedule. This cannot be undone if EMIs are already paid.
                    </div>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" onclick="return confirm('Save changes to this loan?')">
                        <i class="bi bi-save me-1"></i> Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<style>
    .x-small { font-size: 0.75rem; }
    .tracking-wider { letter-spacing: 0.05em; }
</style>
{% endblock %}